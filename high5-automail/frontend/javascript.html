<script>
    // Global vars 
    var Automail = {};
    Automail.currentForm = {};
    Automail.currentForm.fetched = false;
    Automail.currentForm.formUrl = "";
    Automail.currentForm.formName = "";
    Automail.currentForm.hasTrigger = false;
    Automail.currentForm.trigger = {};
    Automail.currentForm.trigger.triggerId = "";
    Automail.currentForm.trigger.destinationId = "";
    Automail.currentForm.trigger.recipients = "";
    Automail.currentForm.trigger.alias = "";
    Automail.currentForm.trigger.ccRecipients = "";
    Automail.currentForm.trigger.bccRecipients = "";
    Automail.currentForm.trigger.draftId = "";
</script>

<script>
    function requestForm() {
        let formUrl = $("#formUrl").val().trim();
        if (formUrl.length == 0 && formUrl.indexOf("edit") < 0) {
            return;
        } else {
            google.script.run.withSuccessHandler(receiveForm).openByUrl(formUrl);
        }
    }

    function receiveForm(formObj) {
        console.log(formObj);
        Object.assign(Automail.currentForm, formObj);
        Automail.currentForm.fetched = true;
        if(Automail.currentForm.hasTrigger){
            $("#formName").text(Automail.currentForm.formName);
            $("#recipients").val(Automail.currentForm.trigger.recipients);
            $("#alias").val(Automail.currentForm.trigger.alias);
            $("#customName").val(Automail.currentForm.trigger.customName);
            $("#ccRecipients").val(Automail.currentForm.trigger.ccRecipients);
            $("#bccRecipients").val(Automail.currentForm.trigger.bccRecipients);
            $("#draftId").val(Automail.currentForm.trigger.draftId);
        }
        $(".primary").prop("disabled", true);
        $(".secondary").prop("disabled", false);
    }
</script>

<!-- setFormAutomail -->
<script>
    function setFormAutomail() {
        if(!Automail.currentForm.fetched){
            console.log("Not fetched!!");
            return;
        }

        //todo check if currentForm.formUrl and #formUrl's ids matche
        var params = Automail.currentForm; //same type as currentForm
        params.trigger = {};
        params.mode = "create";
        
        if (Automail.currentForm.hasTrigger){
            params.mode = "update";
        }

        params.formUrl = $("#formUrl").val();
        params.trigger.recipients = $("#recipients").val();
        params.trigger.alias = $("#alias").val();
        params.trigger.customName = $("#customName").val();
        params.trigger.ccRecipients = $("#ccRecipients").val();
        params.trigger.bccRecipients = $("#bccRecipients").val();
        params.trigger.draftId = $("#draftId").val();

        console.log(params);
        google.script.run
            .withSuccessHandler(setFormAutomailSuccess)
            .withFailureHandler(setFormAutomailFailure)
            .setFormAutomail(params);
        //todo
    }

    function setFormAutomailSuccess(event){
        console.log(event);
    }

    function setFormAutomailFailure(event){
        console.log(event);
    }
</script>

<!-- document.ready  -->
<script>
    $(function () {
        //get draft buttons
        $('#emailDraftRefresh').hover(
            function () { $(this).addClass('fa-spin') },
            function () { $(this).removeClass('fa-spin') }
        ).click(e => {
            google.script.run
                .withSuccessHandler(tags => {
                    $("#draftId")
                        .html(tags)
                        .fadeOut(100)
                        .fadeIn(100);
                    $("#emailDraftRefresh").removeClass("fa-spin");
                })
                .generateDraftsOptionTags();
        });

        $("#menuButton").click(function () {
            var x = $("#myTopnav");
            if (x.hasClass("responsive")) {
                x.removeClass("responsive");
            } else {
                x.addClass("responsive");
            }
        });

        $("#btnGetForm").click(requestForm);
        $("#btnSubmit").click(setFormAutomail);
        $(".secondary").prop('disabled', true);
        $("#btnReset").click(() => {
            $("#formName").text("");
            $('.primary').prop("disabled", false);
            $(".secondary").prop('disabled', true);
            Automail.currentForm.fetched = false;
        });
    })
</script>